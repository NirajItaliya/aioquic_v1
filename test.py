import binascii

import QUICHeader
import socket
from utils.string_to_ascii import string_to_ascii
from utils.packet_to_hex import extract_from_packet, extract_from_packet_as_bytestring
import random
from events.Events import SendInitialCHLOEvent, SendGETRequestEvent, CloseConnectionEvent, SendFullCHLOEvent, ZeroRTTCHLOEvent, ResetEvent
from utils.SessionInstance import SessionInstance
from Crypto.Cipher import AES
from aioquic.quic.crypto import hkdf_extract,hkdf_expand_label,cipher_suite_hash , CipherSuite, AEAD, CryptoError, HeaderProtection ,CryptoContext,CryptoPair
from crypto.Secret import dhke
from CryptoFrame import CryptoFrame
from donna25519 import PrivateKey, PublicKey
from cryptography.hazmat.primitives.kdf.hkdf import HKDF
from cryptography.hazmat.primitives import hashes

from functools import partial

import certifi
import service_identity
from cryptography import x509
from cryptography.exceptions import InvalidSignature
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import hashes, hmac, serialization
from cryptography.hazmat.primitives.asymmetric import (
    dsa,
    ec,
    ed448,
    ed25519,
    padding,
    rsa,
    x448,
    x25519,
)
from cryptography.hazmat.primitives.kdf.hkdf import HKDFExpand
from cryptography.hazmat.primitives.serialization import Encoding, PublicFormat

import hashlib


# s = "c7c3b9a24d436ed311c3f64bd96d1e336026dd5f979e05981921dfa2b0f66231"

SessionInstance.get_instance().tlschlo = bytes.fromhex("0100017503037a45aa675cc2f2e6679898c1f91f4cf2a128fbfba54aca1813a4fdf01584544800000613021301130301000146003300a700a500170041047f5475bc9cdc9f83a2151e4f68ed25226819fbc595935a5ec2df29ccf60639fee5a3d9c6c4a04346168054d3b048bb8b2045e0a3b7799a0efa0cbc380296078d001d0020a109c4a1ade09596d586a74f41b1c485e45a064d4dee8fa7932ed7e0cab26d76001e0038d2065cb9221bf2be88ea71632e0c42f1001dcd64b120f416cfee1fd5dece87a62fadb2556d0912099d0675b5679dad6937bab79967eac6c3002b0003020304000d000e000c080404030401020108070808000a000800060017001d001e002d000201010000000e000c0000096c6f63616c686f73740010001d001b0268330568332d33320568332d33310568332d33300568332d32390039003901048000ea6004048010000005048010000006048010000007048010000008024080090240800a01030b01190e01080f085897461513bbbed9")

SessionInstance.get_instance().tlsshalo = bytes.fromhex("020000770303d57aaf3e08bd0082dc3a078a7429416b90775cae019706e7cb0fabfcfd4c381700130200004f002b00020304003300450017004104038b166cacb53008c3a56bd0c4cdb41a3d73e99ead074631e58569a364e9ad915771bb400004abae14792d756d4d0847ee4da43ba25cb7dd5f82374d84b39f80")


SessionInstance.get_instance().crypto_cert = bytes.fromhex("0b0005fe000005fa0005f5308205f130820459a003020102020900cb2d80995a69525c300d06092a864886f70d01010b0500304d310b300906035504061302585931263024060355040a0c1d507974686f6e20536f66747761726520466f756e646174696f6e2043413116301406035504030c0d6f75722d63612d736572766572301e170d3138303832393134323331365a170d3238303730373134323331365a305f310b30090603550406130258593117301506035504070c0e436173746c6520416e746872617831233021060355040a0c1a507974686f6e20536f66747761726520466f756e646174696f6e3112301006035504030c096c6f63616c686f7374308201a2300d06092a864886f70d01010105000382018f003082018a02820181009f282f3741ef7f6463166216e901146229ca3a98923d08d35e69fec0f3d4c4fb0e58dc64b04bcbb3aa9e42e9079b6733cdb9e83c1d8a13c0df39677c4cd37ebf430f4a85056d87e5c302a33ed7d7b9287918731837777648d47818d7bd1e6a468b06f30337950ba053b022cd8fb70336a3d72377999f4ae5adb48ebe7c2aa8a7cfe5f1c7ab1bd897d861f7f69de25b05a84d9b989dd000f6a62fd3b6166a3b90d4449628f8c76064e732fbb8c48ce26c2d665ddd8ceaefc88cd3ba838dba48a15a443590931d3580857f0b22acf43819a1e30790a66e3ea6553b138af80fcdae6aea1c5b0f22caece7093b400563bb9fd7d6c9299ff50642598c47005a4142ceb3515a800fb9e115d4eaa50f5b4626849e31381e201c70f5be300a12c459effeb37313323a6f8cd436ca4531f83568d55a99d8f1769519d461b53a47f4c8f27292a117e0f665dcb6b505edaaed8675c32751e76dd777e7f710ee3f83e8a611348a9fc83209fe91be26f5ef92f8af6595d425d01fb805c19602a1de961d8ab94d0203010001a38201c0308201bc30140603551d11040d300b82096c6f63616c686f7374300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030106082b06010505070302300c0603551d130101ff04023000301d0603551d0e041604148fea1de3335c0016b38b6f6b6fd34ccbb5cb7c55307d0603551d23047630748014ddbfcadae6d134ba377521ca6f9a0828f235b648a151a44f304d310b300906035504061302585931263024060355040a0c1d507974686f6e20536f66747761726520466f756e646174696f6e2043413116301406035504030c0d6f75722d63612d736572766572820900cb2d80995a69525b30818306082b0601050507010104773075303c06082b060105050730028630687474703a2f2f7465737463612e707974686f6e746573742e6e65742f7465737463612f70796361636572742e636572303506082b060105050730018629687474703a2f2f7465737463612e707974686f6e746573742e6e65742f7465737463612f6f6373702f30430603551d1f043c303a3038a036a0348632687474703a2f2f7465737463612e707974686f6e746573742e6e65742f7465737463612f7265766f636174696f6e2e63726c300d06092a864886f70d01010b0500038201810027f58c5910f4c6e72800bfba8d7b1303f11ca65fb30655a422b9dbb2d546bdf70cdd436eb4796567210c2a55ee408e859f9f47bb0a2a4db6647498a07faedcf12edb427718e0758b263568c341ed6bc877726f6a9a5d556902fd5a54c857cbb0650316e20f00399966a09b889317e25a2d79355f975778c4aff5995e86abd311ad1aa20dfa5210b9febf9dce33d986b29c16f8d675088adb0ae5b42b167fb4f92a9fc3d277d7cd651ef46c1eeb59b9f0ae5fa41fcc4ac4b97aa9d96b32683be165b084b790c4aefef4374f21a0de9f3ab1e5cc1604663f0b41dc423d203eecb7952b3557fabe7fb63abaca4f58fe753e08892c8cb05d2ef989102bf941464f3c00b727d36524281723263142ea7e4e93e47b6854ca9f46f3ef2be9850cb584b2d5353480752bf09123b808018eb90a54d4fb3452fed945f0803bb6c16f82d11ff23b08f646a69627614b58327a0e1d59c544ad5e1a7933c1d4052f4ad3d842428d33e363cad587979b4db81a0334bb1cd2023f5923e223808863c2f0a263a88b0000")

SessionInstance.get_instance().crypto_certverify = bytes.fromhex("0f000184080401801d677ef746f942fde7318a5c0f60be668698ab7de9160bc3b22f2699e98966c885062254135f205a86f2009363e3042f3e04f25e39bffab0e82d819512a9396bb48bd1f33b4140a63eef0da5047a7cdb0a985dfe2ff590bb56e06c6c0a12a09941dc2408081380172181186635001126b9f4b4c8254ddce50e21567b567ba11474d82307232eb5a9f29d0c7dd1fe721b70afa0c76f4c4934bb2af2af2a6adf2be90b0d6856c41934eb5341109a7815cb237a8b830220c6860dcda99c0baa47978b43eefa0b334abcfd84978f756589373bc9dff7c97b246c7026232b82d85d39f2c2e9e08be11bdde008dd3426ac59064c86c21eef3d1fe471ffd3bd8262686a588281118a41d1753c361ab58b1882a2ae17156446ec1d27694f09cf112d76b1f023bf4ee7caaf373b19c9b2fad389e095d77177213f8752a01556bf92b7d19d60355fba324ef61d092693e75f41390aebe73e618e688d3e87c9e991f5bfa25566c733f67aabd39d18f2efdc158267267b76c93d86ea81363e92caac62af8537")

SessionInstance.get_instance().crypto_extensions = bytes.fromhex("0800006a00680010000500030268330039005b00087d9107487bea983401048000ea6002100f79ca5fad6f6cc52ac405c076beb2ad04048010000005048010000006048010000007048010000008024080090240800a01030b01190e01080f0868b5c86c1266f565200480010000")

SessionInstance.get_instance().crypto_finished = bytes.fromhex("14000030bdb93774de4948059a4d26c39688e731879a8561ea3b134428fc912a6ed3295b4fa5dbc0f08053c9393504ad4730f878")

# "39c35494cce2207a1eab11fe332f9c58bcf5a4a73bd92b2bd611ca571d0791c090d199d91a1043ac87743e0d5489964f"
handshake_client_secrte = dhke.handshake_secret(cipher_suite = 0x1302,shared_key =bytes.fromhex("8c7e8a454901a288b039f9e4732c09690eac55aaec6f90504bfb86014d0b6069"),lable = b"c hs traffic")
# finsh_hash : "142ee0d0d91bec4c68a14c612885bc4fa00046c0446b89f311865e9272f210e884232d19d6fb230fbbaef0723dec70f4"
print("handshake_client_secrte: " ,bytes.hex(handshake_client_secrte))
# handshake_client_secrte: 7c1a5cc128a4d74f278c2399c2a46638e63218e7f7accf3af46337a28fba56efc6574d6cb73995999d11a78db81d538d
# "2f1ef87e634df7840ccc6f278b846425953ab9c24eaf926e1fcce17817635647f08bef376207d60e45596e6a695da98b"
finsh_data = dhke.finished_verify_data(0x1302,handshake_client_secrte)
print(bytes.hex(finsh_data))





