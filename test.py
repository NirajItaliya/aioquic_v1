import binascii

import QUICHeader
import socket
from utils.string_to_ascii import string_to_ascii
from utils.packet_to_hex import extract_from_packet, extract_from_packet_as_bytestring
import random
from events.Events import SendInitialCHLOEvent, SendGETRequestEvent, CloseConnectionEvent, SendFullCHLOEvent, ZeroRTTCHLOEvent, ResetEvent
from utils.SessionInstance import SessionInstance
from Crypto.Cipher import AES
from aioquic.quic.crypto import hkdf_extract,hkdf_expand_label,cipher_suite_hash , CipherSuite, AEAD, CryptoError, HeaderProtection ,CryptoContext,CryptoPair
from crypto.Secret import secret_all
from CryptoFrame import CryptoFrame
from donna25519 import PrivateKey, PublicKey
from cryptography.hazmat.primitives.kdf.hkdf import HKDF
from cryptography.hazmat.primitives import hashes

from functools import partial

import certifi
import service_identity
from cryptography import x509
from cryptography.exceptions import InvalidSignature
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import hashes, hmac, serialization
from cryptography.hazmat.primitives.asymmetric import (
    dsa,
    ec,
    ed448,
    ed25519,
    padding,
    rsa,
    x448,
    x25519,
)
from cryptography.hazmat.primitives.kdf.hkdf import HKDFExpand
from cryptography.hazmat.primitives.serialization import Encoding, PublicFormat
from crypto.Secret import secret_all
import hashlib

server_handshake_packet = bytes.fromhex("ed0000000105635f63696405735f6369644414b7dd73ae296209dff2d02d3d50af692176dd4d509fe8cb1b46e45b09364d815fa7a5748e2180dad2b7b668cab86fbdc2988c45cbb851ddcf1601b780d748b9ee641ebcbe20126e32267e664d2f37cf53b753d124717c2e13c48a09e3428b11dc73baebd498e8caf5becefea760d0e7a5cdb76b52bcb19229973e5d09aa055e9c9718dc581454775c58ecdd5ee7e77278f5601070404162a79ee8c59645d6ca24a200186ae99ce47eace1cfc9527b24ae8bc6ccdbacb79b81c91a26954707ba35cba0cae9aff418c6e08da6506163a39f19b676a66ac174e3295f1ab9ea7383a9c285d73e95758dc9bd8da90734a9fedfd7e1f74d2b69c70bf739a48c5a5d0afa0bfa1603471b0c61a9cade120b3986a6ce0295be8228c6927013b06da58d31996231b9e3150bb58270960e61cbc6698a2f1379a2258465da7325b349c6cd55d105fd5485fd0ac79a1df1dbba7f85b49b72365bfab9d578e01dcbff8515a632fd7001382ed90f6cdcb17db99a33fa1181f6f61a89e783cfb042fc0f2f67cdb60e89f263885681ae645a1c7ab1590eb2f8469f460f04e09fea2a3a411b498663010b3c382a3f25837c2c7086af5a9ad290cf3ccf1ac6eb0f445535e8b00a557c87a53d93071462a0bc22614e5c3ae08417b720a736c1ad48ea3775cd0f009f0c57500e0bb2e7e9c53f83699a47e5f13bb20772ab23506424b76f6ef96a61c917226e6e048de6f82426ca63eabf3b5943af0b5f0d123d9af045bb357cadbd1092ad0a1d7551162a3b4b486c271e00244b23d8adec81c92e31239c75af41cb079808571b48acb507333ffbf1a486d8053edcc862b6a9bfd36a09cddba3291b9b8ba158493459805ce241daf5c1308599fc0e6e6ea7103033b294cc7a5fdb2d4654f1d4407825ebc375abdfb2cca1abf5a241343dec3b165d320af84bc1fa21112efdb9d45c6cfc7b8a6442ff593d09219336fa0756d9e45bab4fa63394a2a8803df4678e79216fdf131f55822f9ead694ab75ee25496e6b78c3b09046658e2c427ddc4538af8de2acb81398b74828337f269cb031d997a5cf63e11ab050aa8aee1f07962ddd7515ab60e192e403c300311e9e4b9b70f1615029d07fe1c231939027149f4fd2972023a55de29356505fbe749908c62aa33eb259a399bf711b92b616cb748de73c8bfadd5d43e2dae916a7ba0db61dfcd6faf957608262b6834e33185b8d5598f87e6992aacf57696add5558a7d9694381f5d7d659da2de951b607478f61da208a24a07ba8da00258fa7f2fe10def6183267f5d38e04c942300b9c874e8983c1be14e1608ffdca67d7e4513cc0cb9cab81d6319dd1074b217e5195465131e06dd0bafaba84eb52c22a4a8c612a405fe6c874232e4a934611bc73c56fe70b2cb7a596c1f53c729b6643cbd70d530fe3196069fc0078e89fbb70dc1b38ab4e1770c8ffb53316d673a32b89259b5d33e94ad")

s = "df4a291baa1eb7cfa6934b29b474baad2697e29f1f920dcc77c8a0a088447624"

SessionInstance.get_instance().tlschlo = bytes.fromhex("010000ea0303000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f000006130113021303010000bb0000001800160000136578616d706c652e756c666865696d2e6e6574000a00080006001d001700180010000b00090870696e672f312e30000d00140012040308040401050308050501080606010201003300260024001d0020358072d6365880d1aeea329adf9121383851ed21a28e3b75e965d0d2cd166254002d00020101002b00030203040039003103048000fff7040480a0000005048010000006048010000007048010000008010a09010a0a01030b01190f05635f636964")

SessionInstance.get_instance().tlsshalo = bytes.fromhex("020000560303707172737475767778797a7b7c7d7e7f808182838485868788898a8b8c8d8e8f00130100002e00330024001d00209fd7ad6dcff4298dd3f96d5b1b2af910a0535b1488d7f8fabb349a982880b615002b00020304")
SessionInstance.get_instance().crypto_cert = bytes.fromhex("0b00032e0000032a0003253082032130820209a0030201020208155a92adc2048f90300d06092a864886f70d01010b05003022310b300906035504061302555331133011060355040a130a4578616d706c65204341301e170d3138313030353031333831375a170d3139313030353031333831375a302b310b3009060355040613025553311c301a060355040313136578616d706c652e756c666865696d2e6e657430820122300d06092a864886f70d01010105000382010f003082010a0282010100c4803606bae7476b089404eca7b691043ff792bc19eefb7d74d7a80d001e7b4b3a4ae60fe8c071fc73e7024c0dbcf4bdd11d396bba70464a13e94af83df3e10959547bc955fb412da3765211e1f3dc776caa53376eca3aecbec3aab73b31d56cb6529c8098bcc9e02818e20bf7f8a03afd1704509ece79bd9f39f1ea69ec47972e830fb5ca95de95a1e60422d5eebe527954a1e7bf8a86f6466d0d9f16951a4cf7a04692595c1352f2549e5afb4ebfd77a37950144e4c026874c653e407d7d23074401f484ffd08f7a1fa05210d1f4f0d5ce79702932e2cabe701fdfad6b4bb71101f44bad666a11130fe2ee829e4d029dc91cdd6716dbb9061886edc1ba94210203010001a3523050300e0603551d0f0101ff0404030205a0301d0603551d250416301406082b0601050507030206082b06010505070301301f0603551d23041830168014894fde5bcc69e252cf3ea300dfb197b81de1c146300d06092a864886f70d01010b05000382010100591645a69a2e3779e4f6dd271aba1c0bfd6cd75599b5e7c36e533eff3659084324c9e7a504079d39e0d42987ffe3ebdd09c1cf1d914455870b571dd19bdf1d24f8bb9a11fe80fd592ba0398cde11e2651e618ce598fa96e5372eef3d248afde17463ebbfabb8e4d1ab502a54ec0064e92f7819660d3f27cf209e667fce5ae2e4ac99c7c93818f8b2510722dfed97f32e3e9349d4c66c9ea6396d744462a06b42c6d5ba688eac3a017bddfc8e2cfcad27cb69d3ccdca280414465d3ae348ce0f34ab2fb9c618371312b191041641c237f11a5d65c844f0404849938712b959ed685bc5c5dd645ed19909473402926dcb40e3469a15941e8e2cca84bb6084636a00000")
SessionInstance.get_instance().crypto_certverify = bytes.fromhex("0f000104080401000a99af32a9e406d725f9a9396de5af3756b7a8f6e4dad585abc3f87c6d1fc15f5f00aba8dca9d05cdb51d3c935433656d88b7432005ee7e04803b2475744d7555cf3de489cc216a485a728b21890e87aa9415d19e63a6a779b9cdbb128a804c428b827fa65dfcd952ace54461e8a234058988e7f264d7ab6a51a21c62979b7a679f4a08770856e926d371b2e89169aa190b803636bb10c0fb905983d2b500aad2683dfbe156eccf666de1a5ad45d7738d5e78bd17bc3e6d25f9ad4afba8f81de9f4d5572118e08551a4bb94b56a970e804c68267454b517fc8386c9bae3a77cccb7f290f6e58fba126f05333a11f8ab0892e6e7a89585382d36eef2529cf5b7b")
SessionInstance.get_instance().crypto_extensions = bytes.fromhex("0800005600540010000b00090870696e672f312e30003900410008000102030405060701048001d4c003048000fff70404805000000504800800000604800800000704800800000801020901020a01030b01190f05735f636964")
SessionInstance.get_instance().crypto_finished = bytes.fromhex("14000020068fcb606aa1c8aa354d7b6064a3328cf376bcd9f3200e68ace3de2ee9fcaccb")

server_handshake_key = secret_all.nth_secret(0x1301,shared_key = bytes.fromhex(s))
print(bytes.hex(server_handshake_key))
server_ap_key = secret_all.ap_secret(0x1301,handshake_secret = server_handshake_key )
print(bytes.hex(server_ap_key))









